/*! espocrm 2023-09-18 */
define("modules/crm/views/scheduler/scheduler",["exports","view","vis-data","vis-timeline","moment","jquery"],function(t,e,a,i,n,s){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,e=r(e),n=r(n),s=r(s);class o extends e.default{templateContent=`
        <div class="timeline"></div>
        <link href="{{basePath}}client/modules/crm/css/vis.css" rel="stylesheet">
    `;rangeMarginThreshold=43200;leftMargin=86400;rightMargin=172800;rangeMultiplierLeft=3;rangeMultiplierRight=3;setup(){this.startField=this.options.startField||"dateStart",this.endField=this.options.endField||"dateEnd",this.assignedUserField=this.options.assignedUserField||"assignedUser",this.startDateField=this.startField+"Date",this.endDateField=this.endField+"Date",this.colors=Espo.Utils.clone(this.getMetadata().get("clientDefs.Calendar.colors")||{}),this.colors={...this.colors,...this.getHelper().themeManager.getParam("calendarColors")};let t="users";!this.model.hasLink("users")&&this.model.hasLink("assignedUsers")&&(t="assignedUsers"),this.eventAssignedUserIsAttendeeDisabled=this.getConfig().get("eventAssignedUserIsAttendeeDisabled")||!1,this.usersField=this.options.usersField||t,this.userIdList=[],this.listenTo(this.model,"change",t=>{if(t.hasChanged("isAllDay")||t.hasChanged(this.startField)||t.hasChanged(this.endField)||t.hasChanged(this.endDateField)||t.hasChanged(this.usersField+"Ids")||!this.eventAssignedUserIsAttendeeDisabled&&t.hasChanged(this.assignedUserField+"Id"))return t.hasChanged(this.assignedUserField+"Id")||t.hasChanged(this.usersField+"Ids")?void(this.isRemoved()||(this.trigger("has-data"),this.reRender())):(this.initDates(!0),this.start&&this.end&&this.userIdList.length?(this.trigger("has-data"),this.timeline&&(this.updateEvent(),this.timeline.setWindow(this.start.toDate(),this.end.toDate())),void(this.noDataShown&&this.reRender())):this.timeline?(this.showNoData(),void this.trigger("no-data")):void 0)}),this.once("remove",()=>{this.destroyTimeline()})}destroyTimeline(){this.timeline&&(this.timeline.destroy(),this.timeline=null)}showNoData(){this.noDataShown=!0,this.destroyTimeline(),this.$timeline.empty(),this.$timeline.append((0,s.default)("<div>").addClass("revert-margin").text(this.translate("No Data")))}afterRender(){let e=this.$timeline=this.$el.find(".timeline");if(this.noDataShown=!1,this.$timeline.empty(),this.initGroupsDataSet(),this.initDates(),e.get(0)){if(e.get(0).innerHTML="",!this.start||!this.end||!this.userIdList.length)return this.showNoData(),void this.trigger("no-data");this.destroyTimeline(),this.lastHeight&&e.css("min-height",this.lastHeight+"px"),this.fetch(this.start,this.end,t=>{t=new a.DataSet(t);this.timeline=new i.Timeline(e.get(0),t,this.groupsDataSet,{dataAttributes:"all",start:this.start.toDate(),end:this.end.toDate(),rollingMode:{follow:!1},moment:t=>{let e=(0,n.default)(t);return t&&t.noTimeZone?e:e.tz(this.getDateTime().getTimeZone())},xss:{filterOptions:{onTag:(t,e)=>e}},format:this.getFormatObject(),zoomable:!1,moveable:!0,orientation:"top",groupEditable:!1,editable:{add:!1,updateTime:!1,updateGroup:!1,remove:!1},showCurrentTime:!0,locales:{myLocale:{current:this.translate("current","labels","Calendar"),time:this.translate("time","labels","Calendar")}},locale:"myLocale",margin:{item:{vertical:12},axis:6}}),e.css("min-height",""),this.timeline.on("rangechanged",t=>{t.skipClick=!0,this.blockClick=!0,setTimeout(function(){this.blockClick=!1}.bind(this),100),this.start=(0,n.default)(t.start),this.end=(0,n.default)(t.end),this.updateRange()}),setTimeout(()=>{this.lastHeight=e.height()},500)})}}updateEvent(){var t=Espo.Utils.cloneDeep(this.busyEventList),t=this.convertEventList(t),t=(this.addEvent(t),new a.DataSet(t));this.timeline.setItems(t)}updateRange(){(this.start.unix()<this.fetchedStart.unix()+this.rangeMarginThreshold||this.end.unix()>this.fetchedEnd.unix()-this.rangeMarginThreshold)&&this.runFetch()}initDates(e){this.start=null,this.end=null;let i=this.model.get(this.startField),s=this.model.get(this.endField);if(this.model.get("isAllDay")&&(i=this.model.get(this.startDateField),s=this.model.get(this.endDateField)),i&&s){this.model.get("isAllDay")?(this.eventStart=n.default.tz(i,this.getDateTime().getTimeZone()),this.eventEnd=n.default.tz(s,this.getDateTime().getTimeZone()),this.eventEnd.add(1,"day")):(this.eventStart=n.default.utc(i).tz(this.getDateTime().getTimeZone()),this.eventEnd=n.default.utc(s).tz(this.getDateTime().getTimeZone()));let t=this.eventEnd.diff(this.eventStart,"hours");this.start=this.eventStart.clone(),this.end=this.eventEnd.clone(),t<0&&(this.end=this.start.clone()),t<1&&(t=1),this.start.add(-t*this.rangeMultiplierLeft,"hours"),this.end.add(t*this.rangeMultiplierRight,"hours"),this.start.startOf("hour"),this.end.endOf("hour"),e||(this.fetchedStart=null,this.fetchedEnd=null)}}runFetch(){this.fetch(this.start,this.end,t=>{t=new a.DataSet(t);this.timeline.setItems(t)})}fetch(e,a,n){e=e.clone().add(-1*this.leftMargin,"seconds"),a=a.clone().add(this.rightMargin,"seconds");let t="Timeline/busyRanges?from="+e.utc().format(this.getDateTime().internalDateTimeFormat)+"&to="+a.utc().format(this.getDateTime().internalDateTimeFormat)+"&userIdList="+encodeURIComponent(this.userIdList.join(","))+"&entityType="+this.model.entityType;this.model.id&&(t+="&entityId="+this.model.id),Espo.Ajax.getRequest(t).then(i=>{this.fetchedStart=e.clone(),this.fetchedEnd=a.clone();let s=[];for(let e in i){let t=i[e].filter(t=>!t.isBusyRange).concat(i[e].filter(t=>t.isBusyRange));t.forEach(t=>{t.userId=e,s.push(t)})}this.busyEventList=Espo.Utils.cloneDeep(s);var t=this.convertEventList(s);this.addEvent(t),n(t)})}addEvent(e){this.getCurrentItemList().forEach(t=>{e.push(t)})}getCurrentItemList(){let i=[],s={start:this.eventStart.clone(),end:this.eventEnd.clone(),type:"background",style:"z-index: 4; opacity: 0.6;",className:"event-range"};var t=this.getColorFromScopeName(this.model.entityType);return t&&(s.style+="; border-color: "+t,t=this.hexToRgb(t),s.style+="; background-color: rgba("+t.r+", "+t.g+", "+t.b+", 0.01)"),this.userIdList.forEach(t=>{let e=Espo.Utils.clone(s);e.group=t,e.id="event-"+t,i.push(e)}),i}convertEventList(t){let e=[];return t.forEach(t=>{t=this.convertEvent(t);t&&e.push(t)}),e}convertEvent(t){let e;var i;if(t.isBusyRange?e={className:"busy",group:t.userId,"date-start":t.dateStart,"date-end":t.dateEnd,type:"background"}:t.isWorkingRange?e={className:"working",group:t.userId,"date-start":t.dateStart,"date-end":t.dateEnd,type:"background"}:t.isNonWorkingRange&&(e={className:"non-working",group:t.userId,"date-start":t.dateStart,"date-end":t.dateEnd,type:"background"},i=this.colors.bg,e.style="background-color:"+i+";",e.style+="border-color:"+i+";"),t.dateStart&&(t.dateStartDate?e.start=n.default.tz(t.dateStartDate,this.getDateTime().getTimeZone()):e.start=this.getDateTime().toMoment(t.dateStart)),t.dateEnd&&(t.dateEndDate?e.end=n.default.tz(t.dateEndDate,this.getDateTime().getTimeZone()):e.end=this.getDateTime().toMoment(t.dateEnd)),t.isBusyRange||t.isNonWorkingRange)return e}initGroupsDataSet(){let i=[],t=Espo.Utils.clone(this.model.get(this.usersField+"Ids")||[]);var e=this.model.get(this.assignedUserField+"Id");let s=this.model.get(this.usersField+"Names")||{};!this.eventAssignedUserIsAttendeeDisabled&&e&&(~t.indexOf(e)||t.unshift(e),s[e]=this.model.get(this.assignedUserField+"Name")),(this.userIdList=t).forEach((t,e)=>{i.push({id:t,content:this.getGroupContent(t,s[t]||t),order:e})}),this.groupsDataSet=new a.DataSet(i)}getGroupContent(t,e){if("single"===this.calendarType)return(0,s.default)("<span>").text(e).get(0).outerHTML;let i=this.getAvatarHtml(t);return i&&(i+=" "),(0,s.default)("<span>").append((0,s.default)(i),(0,s.default)("<span>").attr("data-id",t).addClass("group-title").text(e)).get(0).innerHTML}getAvatarHtml(t){if(this.getConfig().get("avatarsDisabled"))return"";let e,i=this.getCache();return e=i?i.get("app","timestamp"):Date.now(),(0,s.default)("<img>").addClass("avatar avatar-link").attr("width","14").attr("src",this.getBasePath()+"?entryPoint=avatar&size=small&id="+t+"&t="+e).get(0).outerHTML}getFormatObject(){return{minorLabels:{millisecond:"SSS",second:"s",minute:this.getDateTime().getTimeFormat(),hour:this.getDateTime().getTimeFormat(),weekday:"ddd D",day:"D",month:"MMM",year:"YYYY"},majorLabels:{millisecond:this.getDateTime().getTimeFormat()+" ss",second:this.getDateTime().getReadableDateFormat()+" HH:mm",minute:"ddd D MMMM",hour:"ddd D MMMM",weekday:"MMMM YYYY",day:"MMMM YYYY",month:"YYYY",year:""}}}getColorFromScopeName(t){return this.getMetadata().get(["clientDefs",t,"color"])||this.getMetadata().get(["clientDefs","Calendar","colors",t])}hexToRgb(t){t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}}t.default=o}),define("modules/crm/views/calendar/timeline",["exports","view","vis-data","vis-timeline","moment","jquery"],function(t,e,s,i,a,n){"use strict";function r(t){return t&&t.__esModule?t:{default:t}}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,e=r(e),a=r(a),n=r(n);class o extends e.default{template="crm:calendar/timeline";eventAttributes=[];colors={};scopeList=[];header=!0;modeList=[];defaultMode="timeline";maxRange=120;rangeMarginThreshold=43200;leftMargin=86400;rightMargin=172800;calendarType="single";calendarTypeList=["single","shared"];zoomPercentage=1;timeline;events={'click button[data-action="today"]':function(){this.actionToday()},'click [data-action="mode"]':function(t){t=(0,n.default)(t.currentTarget).data("mode");this.selectMode(t)},'click [data-action="refresh"]':function(){this.actionRefresh()},'click [data-action="toggleScopeFilter"]':function(t){let e=(0,n.default)(t.currentTarget);var i=e.data("name");let s=e.find(".filter-check-icon");s.hasClass("hidden")?s.removeClass("hidden"):s.addClass("hidden"),t.stopPropagation(t),this.toggleScopeFilter(i)},'click [data-action="toggleCalendarType"]':function(t){let e=(0,n.default)(t.currentTarget);t=e.data("name");e.parent().parent().find(".calendar-type-check-icon").addClass("hidden");let i=e.find(".calendar-type-check-icon"),s=(i.hasClass("hidden")&&i.removeClass("hidden"),e.closest(".calendar-type-button-group").find(".calendar-type-label").text(this.getCalendarTypeLabel(t)),this.$el.find('> .button-container button[data-action="showSharedCalendarOptions"]'));"shared"===t?s.removeClass("hidden"):s.addClass("hidden"),this.selectCalendarType(t)},'click button[data-action="addUser"]':function(){this.actionAddUser()},'click button[data-action="showSharedCalendarOptions"]':function(){this.actionShowSharedCalendarOptions()}};data(){var t=this.getCalendarTypeDataList();return{mode:this.mode,header:this.header,calendarType:this.calendarType,calendarTypeDataList:t,calendarTypeSelectEnabled:1<t.length,calendarTypeLabel:this.getCalendarTypeLabel(this.calendarType),isCustomViewAvailable:this.isCustomViewAvailable}}setup(){this.date=this.options.date||this.getDateTime().getToday(),this.mode=this.options.mode||this.defaultMode,this.header=("header"in this.options?this.options:this).header,this.$container=this.options.$container,this.colors=Espo.Utils.clone(this.getMetadata().get("clientDefs.Calendar.colors")||this.colors||{}),this.modeList=this.getMetadata().get("clientDefs.Calendar.modeList")||this.modeList||[],this.scopeList=this.getConfig().get("calendarEntityList")||Espo.Utils.clone(this.scopeList)||[],this.allDayScopeList=this.getMetadata().get("clientDefs.Calendar.allDayScopeList")||this.allDayScopeList||[],this.colors={...this.colors,...this.getHelper().themeManager.getParam("calendarColors")},this.isCustomViewAvailable="no"!==this.getAcl().getPermissionLevel("userPermission"),this.options.userId&&(this.isCustomViewAvailable=!1);let e=[];this.scopeList.forEach(t=>{this.getAcl().check(t)&&e.push(t)}),this.scopeList=e,this.header?this.enabledScopeList=this.getStoredEnabledScopeList()||Espo.Utils.clone(this.scopeList):this.enabledScopeList=this.options.enabledScopeList||Espo.Utils.clone(this.scopeList),"[object Array]"!==Object.prototype.toString.call(this.enabledScopeList)&&(this.enabledScopeList=[]),this.enabledScopeList.forEach(t=>{var e=this.getMetadata().get(["clientDefs",t,"color"]);e&&(this.colors[t]=e)}),this.options.calendarType?this.calendarType=this.options.calendarType:this.options.userId?this.calendarType="single":this.calendarType=this.getStorage().get("calendar","timelineType")||"shared",this.getAcl().get(!1)&&"shared"===this.calendarType&&(this.calendarType="single"),~this.calendarTypeList.indexOf(this.calendarType)||(this.calendarType="single"),this.header&&this.createView("modeButtons","crm:views/calendar/mode-buttons",{selector:".mode-buttons",isCustomViewAvailable:this.isCustomViewAvailable,modeList:this.modeList,scopeList:this.scopeList,mode:this.mode})}getModeButtonsView(){return this.getView("modeButtons")}selectMode(t){this.trigger("change:mode",t)}getCalendarTypeDataList(){let t=[];var e={type:"single",disabled:"single"!==this.calendarType,label:this.getCalendarTypeLabel("single")};return t.push(e),this.options.userId||"no"!==this.getAcl().get("userPermission")&&t.push({type:"shared",label:this.getCalendarTypeLabel("shared"),disabled:"shared"!==this.calendarType}),t}getCalendarTypeLabel(t){let e;return"single"===t?(e=this.options.userId?this.options.userName||this.options.userId:this.getUser().get("name"),e=this.getHelper().escapeString(e)):"shared"===t?this.translate("Shared","labels","Calendar"):void 0}selectCalendarType(t){this.calendarType=t,this.initUserList(),this.initGroupsDataSet(),this.timeline.setGroups(this.groupsDataSet),this.runFetch(),this.getStorage().set("calendar","timelineType",t)}toggleScopeFilter(t){var e=this.enabledScopeList.indexOf(t);~e?this.enabledScopeList.splice(e,1):this.enabledScopeList.push(t),this.storeEnabledScopeList(this.enabledScopeList),this.runFetch()}getStoredEnabledScopeList(){return this.getStorage().get("state","calendarEnabledScopeList")||null}storeEnabledScopeList(t){this.getStorage().set("state","calendarEnabledScopeList",t)}getTitle(){let t="";return this.options.userId&&this.options.userName&&(t+=" ("+this.options.userName+")"),t=this.getHelper().escapeString(t)}convertEvent(e){var t=e.userId||this.userList[0].id||this.getUser().id;let i;if(i=e.isBusyRange?{className:"busy",group:t,"date-start":e.dateStart,"date-end":e.dateEnd,type:"background"}:e.isWorkingRange?{className:"working",group:t,"date-start":e.dateStart,"date-end":e.dateEnd,type:"background"}:e.isNonWorkingRange?{className:"non-working",group:t,"date-start":e.dateStart,"date-end":e.dateEnd,type:"background"}:{content:this.getHelper().escapeString(e.name),title:this.getHelper().escapeString(e.name),id:t+"-"+e.scope+"-"+e.id,group:t,"record-id":e.id,scope:e.scope,status:e.status,"date-start":e.dateStart,"date-end":e.dateEnd,type:"range",className:"clickable",color:e.color},this.eventAttributes.forEach(t=>{i[t]=e[t]}),e.dateStart&&(e.dateStartDate?i.start=a.default.tz(e.dateStartDate,this.getDateTime().getTimeZone()):i.start=this.getDateTime().toMoment(e.dateStart)),e.dateEnd&&(e.dateEndDate?i.end=a.default.tz(e.dateEndDate,this.getDateTime().getTimeZone()):i.end=this.getDateTime().toMoment(e.dateEnd)),e.dateStartDate&&!~this.allDayScopeList.indexOf(e.scope)&&(i.end=i.end.clone().add(1,"days")),e.isBusyRange)return i;if(~this.allDayScopeList.indexOf(e.scope))i.type="box",i.end&&(e.dateEndDate?i.start=i.end.clone().add(1,"days"):i.start=i.end.clone());else if(!i.end||!i.start)return;return this.fillColor(i),e.isNonWorkingRange||this.handleStatus(i),i}getEventTypeCompletedStatusList(t){return this.getMetadata().get(["scopes",t,"completedStatusList"])||[]}getEventTypeCanceledStatusList(t){return this.getMetadata().get(["scopes",t,"canceledStatusList"])||[]}fillColor(t){let e=t.scope,i=("non-working"===t.className&&(e="bg"),this.colors[e]);i=(i=t.color?t.color:i)||this.getColorFromScopeName(t.scope),t.status&&(this.getEventTypeCompletedStatusList(t.scope).includes(t.status)||this.getEventTypeCanceledStatusList(t.scope).includes(t.status))&&(i=this.shadeColor(i,.4)),t.style=t.style||"",t.style+="background-color:"+i+";",t.style+="border-color:"+i+";"}handleStatus(t){this.getEventTypeCanceledStatusList(t.scope).includes(t.status)&&(t.className+=" event-canceled")}shadeColor(t,e){if("transparent"===t)return t;this.getThemeManager().getParam("isDark")&&(e*=-1);var i=t.substring(7),t=parseInt(t.slice(1,7),16),s=e<0?0:255,e=e<0?-1*e:e,a=t>>16,n=t>>8&255,t=255&t;return"#"+(16777216+65536*(Math.round((s-a)*e)+a)+256*(Math.round((s-n)*e)+n)+(Math.round((s-t)*e)+t)).toString(16).slice(1)+i}convertEventList(t){let e=[];return t.forEach(t=>{t=this.convertEvent(t);t&&e.push(t)}),e}afterRender(){this.options.containerSelector&&(this.$container=(0,n.default)(this.options.containerSelector));let e=this.$timeline=this.$el.find("div.timeline");this.initUserList(),this.initDates(),this.initGroupsDataSet(),this.fetchEvents(this.start,this.end,t=>{t=new s.DataSet(t);this.timeline=new i.Timeline(e.get(0),t,this.groupsDataSet,{dataAttributes:"all",start:this.start.toDate(),end:this.end.toDate(),rollingMode:{follow:!1},xss:{filterOptions:{onTag:(t,e)=>e}},moment:t=>{let e=(0,a.default)(t);return t&&t.noTimeZone?e:e.tz(this.getDateTime().getTimeZone())},format:this.getFormatObject(),zoomMax:864e5*this.maxRange,zoomMin:9e5,orientation:"top",groupEditable:!1,editable:{add:!1,updateTime:!1,updateGroup:!1,remove:!1},locales:{myLocale:{current:this.translate("current","labels","Calendar"),time:this.translate("time","labels","Calendar")}},locale:"myLocale",margin:{item:{vertical:12},axis:6}}),this.timeline.on("click",e=>{if(!this.blockClick)if(e.item){let t=this.$el.find('.timeline .vis-item[data-id="'+e.item+'"]');var i=t.attr("data-record-id"),s=t.attr("data-scope");void(i&&s&&this.viewEvent(s,i))}else"background"===e.what&&e.group&&e.time&&(s=(0,a.default)(e.time).utc().format(this.getDateTime().internalDateTimeFormat),this.createEvent(s,e.group))}),this.timeline.on("rangechanged",t=>{t.skipClick=!0,this.blockClick=!0,setTimeout(()=>{this.blockClick=!1},100),this.start=(0,a.default)(t.start),this.end=(0,a.default)(t.end),this.triggerView(),(this.start.unix()<this.fetchedStart.unix()+this.rangeMarginThreshold||this.end.unix()>this.fetchedEnd.unix()-this.rangeMarginThreshold)&&this.runFetch()}),this.once("remove",()=>{this.timeline.destroy()})})}createEvent(t,i){var e;t||(e=(this.timeline.getWindow().end-this.timeline.getWindow().start)/2+this.timeline.getWindow().start,t=(0,a.default)(e).utc().format(this.getDateTime().internalDateTimeFormat),this.date===this.getDateTime().getToday()&&(t=(0,a.default)().utc().format(this.getDateTime().internalDateTimeFormat)));let s={dateStart:t};if(i){let e;this.userList.forEach(t=>{t.id===i&&(e=t.name)}),s.assignedUserId=i,s.assignedUserName=e||i}Espo.Ui.notify(" ... "),this.createView("quickEdit","crm:views/calendar/modals/edit",{attributes:s,enabledScopeList:this.enabledScopeList,scopeList:this.scopeList},t=>{t.render(),t.notify(!1),this.listenTo(t,"after:save",()=>{this.runFetch()})})}viewEvent(t,e){Espo.Ui.notify(" ... ");var i=this.getMetadata().get(["clientDefs",t,"modalViews","detail"])||"views/modals/detail";this.createView("quickView",i,{scope:t,id:e,removeDisabled:!1},i=>{i.render(),i.notify(!1),this.listenToOnce(i,"after:destroy",()=>{this.runFetch()}),this.listenTo(i,"after:save",(t,e)=>{(e=e||{}).bypassClose||i.close(),this.runFetch()})})}runFetch(){this.fetchEvents(this.start,this.end,t=>{t=new s.DataSet(t);this.timeline.setItems(t),this.triggerView()})}getFormatObject(){return{minorLabels:{millisecond:"SSS",second:"s",minute:this.getDateTime().getTimeFormat(),hour:this.getDateTime().getTimeFormat(),weekday:"ddd D",day:"D",month:"MMM",year:"YYYY"},majorLabels:{millisecond:this.getDateTime().getTimeFormat()+" ss",second:this.getDateTime().getReadableDateFormat()+" HH:mm",minute:"ddd D MMMM",hour:"ddd D MMMM",weekday:"MMMM YYYY",day:"MMMM YYYY",month:"YYYY",year:""}}}triggerView(){let t=this.start.clone().add(Math.round((this.end.unix()-this.start.unix())/2),"seconds");var e=t.format(this.getDateTime().internalDateFormat);this.date=e,this.trigger("view",e,this.mode)}initUserList(){return this.options.userList?(this.userList=Espo.Utils.clone(this.options.userList),void(this.userList.length||this.userList.push({id:this.getUser().id,name:this.getUser().get("name")}))):(this.userList=[],"single"===this.calendarType?this.options.userId?void this.userList.push({id:this.options.userId,name:this.options.userName||this.options.userId}):void this.userList.push({id:this.getUser().id,name:this.getUser().get("name")}):void("shared"===this.calendarType&&this.getSharedCalenderUserList().forEach(t=>{this.userList.push({id:t.id,name:t.name})})))}storeUserList(){this.getPreferences().save({sharedCalendarUserList:Espo.Utils.clone(this.userList)},{patch:!0})}addSharedCalenderUser(e,t,i){let s=!1;this.userList.forEach(t=>{t.id===e&&(s=!0)}),s||(this.userList.push({id:e,name:t}),i||this.storeUserList())}getSharedCalenderUserList(){let t=Espo.Utils.clone(this.getPreferences().get("sharedCalendarUserList"));if(t&&t.length){let e=!1;if(t.forEach(t=>{"object"==typeof t&&t.id&&t.name||(e=!0)}),!e)return t}return[{id:this.getUser().id,name:this.getUser().get("name")}]}initDates(){this.date?this.start=a.default.tz(this.date,this.getDateTime().getTimeZone()):this.start=a.default.tz(this.getDateTime().getTimeZone()),this.end=this.start.clone(),this.end.add(1,"day"),this.fetchedStart=null,this.fetchedEnd=null}initGroupsDataSet(){let i=[];this.userList.forEach((t,e)=>{i.push({id:t.id,content:this.getGroupContent(t.id,t.name),order:e})}),this.groupsDataSet=new s.DataSet(i)}getGroupContent(t,e){if("single"===this.calendarType)return(0,n.default)("<span>").text(e).get(0).outerHTML;let i=this.getAvatarHtml(t);return i&&(i+=" "),i+(0,n.default)("<span>").attr("data-id",t).addClass("group-title").text(e).get(0).outerHTML}getAvatarHtml(t){if(this.getConfig().get("avatarsDisabled"))return"";let e,i=this.getCache();return e=i?i.get("app","timestamp"):Date.now(),(0,n.default)("<img>").addClass("avatar avatar-link").attr("width","14").attr("src",this.getBasePath()+"?entryPoint=avatar&size=small&id="+t+"&t="+e).get(0).outerHTML}fetchEvents(e,a,n){this.options.noFetchLoadingMessage||Espo.Ui.notify(" ... "),e=e.clone().add(-1*this.leftMargin,"seconds"),a=a.clone().add(this.rightMargin,"seconds");let t="Timeline?from="+e.utc().format(this.getDateTime().internalDateTimeFormat)+"&to="+a.utc().format(this.getDateTime().internalDateTimeFormat),i=this.userList.map(t=>t.id);1===i.length?t+="&userId="+i[0]:t+="&userIdList="+encodeURIComponent(i.join(",")),t+="&scopeList="+encodeURIComponent(this.enabledScopeList.join(",")),Espo.Ajax.getRequest(t).then(i=>{this.fetchedStart=e.clone(),this.fetchedEnd=a.clone();let s=[];for(let e in i){let t=i[e];t.forEach(t=>{t.userId=e,s.push(t)})}var t=this.convertEventList(s);n(t),Espo.Ui.notify(!1)})}actionShowSharedCalendarOptions(){this.createView("dialog","crm:views/calendar/modals/shared-options",{userList:this.userList},t=>{t.render(),this.listenToOnce(t,"save",t=>{this.userList=t.userList,this.storeUserList(),this.initGroupsDataSet(),this.timeline.setGroups(this.groupsDataSet),this.runFetch()})})}actionAddUser(){let t=[];"team"===this.getAcl().get("userPermission")&&t.push("onlyMyTeam");var e=this.getMetadata().get("clientDefs."+this.foreignScope+".modalViews.select")||"views/modals/select-records";Espo.Ui.notify(" ... "),this.createView("dialog",e,{scope:"User",createButton:!1,boolFilterList:t,multiple:!0},t=>{t.render(),Espo.Ui.notify(!1),this.listenToOnce(t,"select",t=>{t.forEach(t=>{this.addSharedCalenderUser(t.id,t.get("name"))}),this.storeUserList(),this.initGroupsDataSet(),this.timeline.setGroups(this.groupsDataSet),this.runFetch()})})}actionRefresh(){this.runFetch()}getColorFromScopeName(s){var t=this.getMetadata().get("clientDefs.Calendar.additionalColorList")||[];if(t.length){var a=this.getMetadata().get("clientDefs.Calendar.colors")||{},n=this.getConfig().get("calendarEntityList")||[];let e=0,i=0;for(let t=0;t<n.length;t++)if(!(n[t]in a)){if(n[t]===s){e=i;break}i++}return e%=t.length,this.colors[s]=t[e],this.colors[s]}}actionPrevious(){var t=this.timeline.getWindow().start;this.timeline.moveTo(t),this.triggerView()}actionNext(){var t=this.timeline.getWindow().end;this.timeline.moveTo(t),this.triggerView()}actionToday(){this.timeline.moveTo((0,a.default)().toDate()),this.triggerView()}actionZoomOut(){this.timeline.zoomOut(this.zoomPercentage),this.triggerView()}actionZoomIn(){this.timeline.zoomIn(this.zoomPercentage)}}t.default=o});
//# sourceMappingURL=espo-timeline.js.map